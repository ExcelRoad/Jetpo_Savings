{% extends "base.html" %}
{% load static %}

{% block title %}בחירת קרנות - {{ portfolio.name }} - Jetpo{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-12">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-3 mb-2">
            <a href="{% url 'portfolio_detail' portfolio.pk %}" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-400 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">בחר קרנות להוספה</h1>
        </div>
        <p class="text-gray-600 dark:text-gray-400">תיק: {{ portfolio.name }}</p>
    </div>

    <!-- Filters Form (GET request) -->
    <form method="get" id="filterForm">
        <div class="bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-700 rounded-lg p-6 mb-6">
            <div class="space-y-4">
                <!-- Top Row: Search, Company, Category -->
                <div class="grid md:grid-cols-3 gap-4">
                    <!-- Search -->
                    <div>
                        <input type="text" name="search" value="{{ search_query }}"
                               placeholder="חיפוש לפי שם קרן או חברה..."
                               class="input">
                    </div>

                    <!-- Company Filter -->
                    <div>
                        <select name="company" class="input" onchange="applyFilters()">
                            <option value="">כל החברות</option>
                            {% for company in all_companies %}
                            <option value="{{ company.id }}" {% if company.id|stringformat:"s" == company_filter %}selected{% endif %}>
                                {{ company.short_name|default:company.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Category Filter -->
                    <div>
                        <select name="category" class="input" onchange="applyFilters()">
                            <option value="">כל הקטגוריות</option>
                            {% for category in all_categories %}
                            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>
                                {{ category }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Bottom Row: Liked Filter and Buttons -->
                <div class="flex items-center justify-between gap-4">
                    <!-- Liked Filter -->
                    <div class="flex items-center gap-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" name="liked" value="true" {% if liked_filter == 'true' %}checked{% endif %}
                                   onchange="applyFilters()"
                                   class="w-4 h-4 text-gray-900 focus:ring-gray-900 border-gray-300 dark:border-gray-600 rounded">
                            <span class="text-sm text-gray-700 dark:text-gray-300">מועדפים בלבד</span>
                        </label>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            סנן
                        </button>
                        <a href="{% url 'holding_select_funds' portfolio.pk %}" class="btn btn-secondary" onclick="clearSelections()">
                            נקה
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Selected Counter & Submit -->
    <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6 flex justify-between items-center">
        <div>
            <span class="text-sm font-medium text-gray-900 dark:text-gray-100">נבחרו: </span>
            <span id="selectedCount" class="text-lg font-bold text-blue-600">0</span>
            <span class="text-sm text-gray-600 dark:text-gray-400"> קרנות</span>
        </div>
        <button type="submit" form="fundSelectionForm" class="btn btn-primary" id="submitBtn" disabled>
            המשך להזנת סכומים
        </button>
    </div>

    <!-- Funds Grid -->
    <form method="post" action="{% url 'holding_add_selected' portfolio.pk %}" id="fundSelectionForm">
        {% csrf_token %}
        {% if funds %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for fund in funds %}
            <div class="card relative p-4 transition-all duration-200 fund-card {% if fund.id in existing_fund_ids %}opacity-50{% endif %}"
                 data-fund-id="{{ fund.id }}"
                 onclick="{% if fund.id not in existing_fund_ids %}toggleFundSelection({{ fund.id }}){% endif %}"
                 style="cursor: {% if fund.id in existing_fund_ids %}not-allowed{% else %}pointer{% endif %}">

                <!-- Hidden Checkbox -->
                <input type="checkbox"
                       name="selected_funds"
                       value="{{ fund.id }}"
                       class="hidden fund-checkbox"
                       id="fund-{{ fund.id }}"
                       {% if fund.id in existing_fund_ids %}disabled{% endif %}>

                <!-- Selection Indicator -->
                <div class="absolute top-2 left-2">
                    <div class="w-5 h-5 rounded border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 flex items-center justify-center selection-indicator">
                        <svg class="w-3 h-3 text-white hidden checkmark" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                </div>

                <!-- Fund Info -->
                <div class="mt-6">
                    <h3 class="font-semibold text-gray-900 dark:text-gray-100 text-sm mb-1 line-clamp-2">
                        {{ fund.name }}
                    </h3>
                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">{{ fund.company.short_name|default:fund.company.name }}</p>
                    <div class="text-sm font-semibold {% if fund.return_rate >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ fund.return_rate }}%
                    </div>
                    {% if fund.id in existing_fund_ids %}
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">כבר בתיק</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="card text-center py-12">
            <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">לא נמצאו קרנות</h3>
            <p class="text-gray-600 dark:text-gray-400">נסה לשנות את הפילטרים או את החיפוש</p>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-12 flex justify-center">
            <nav class="flex items-center gap-2">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if company_filter %}&company={{ company_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if liked_filter %}&liked={{ liked_filter }}{% endif %}"
                   class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-lg">
                    ←
                </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <span class="px-4 py-2 text-sm font-medium text-white bg-gray-900 dark:bg-gray-700 border border-gray-900 dark:border-gray-700 rounded-lg">
                        {{ num }}
                    </span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if company_filter %}&company={{ company_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if liked_filter %}&liked={{ liked_filter }}{% endif %}"
                       class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        {{ num }}
                    </a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if company_filter %}&company={{ company_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if liked_filter %}&liked={{ liked_filter }}{% endif %}"
                   class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-lg">
                    →
                </a>
                {% endif %}
            </nav>
        </div>
        {% endif %}
    </form>
</div>

<script>
// LocalStorage key for storing selected funds
const STORAGE_KEY = 'portfolio_{{ portfolio.pk }}_selected_funds';

function getSelectedFunds() {
    const stored = localStorage.getItem(STORAGE_KEY);
    return stored ? JSON.parse(stored) : [];
}

function saveSelectedFunds(selectedFunds) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(selectedFunds));
}

function toggleFundSelection(fundId) {
    const card = document.querySelector(`[data-fund-id="${fundId}"]`);
    const checkbox = document.getElementById(`fund-${fundId}`);
    const indicator = card.querySelector('.selection-indicator');
    const checkmark = card.querySelector('.checkmark');

    // Toggle checkbox
    checkbox.checked = !checkbox.checked;

    // Update localStorage
    let selectedFunds = getSelectedFunds();
    if (checkbox.checked) {
        if (!selectedFunds.includes(fundId)) {
            selectedFunds.push(fundId);
        }
    } else {
        selectedFunds = selectedFunds.filter(id => id !== fundId);
    }
    saveSelectedFunds(selectedFunds);

    // Update card appearance
    if (checkbox.checked) {
        // Selected state - light blue border
        card.style.borderColor = 'rgb(96, 165, 250)';
        card.style.borderWidth = '2px';
        // Update indicator
        indicator.style.backgroundColor = 'rgb(96, 165, 250)';
        indicator.style.borderColor = 'rgb(96, 165, 250)';
        checkmark.classList.remove('hidden');
    } else {
        // Unselected state - default border
        card.style.borderColor = '';
        card.style.borderWidth = '';
        // Update indicator
        const isDark = document.documentElement.classList.contains('dark');
        indicator.style.backgroundColor = isDark ? 'rgb(55, 65, 81)' : 'white';
        indicator.style.borderColor = isDark ? 'rgb(75, 85, 99)' : 'rgb(209, 213, 219)';
        checkmark.classList.add('hidden');
    }

    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedFunds = getSelectedFunds();
    document.getElementById('selectedCount').textContent = selectedFunds.length;
    document.getElementById('submitBtn').disabled = selectedFunds.length === 0;
}

function restoreSelections() {
    const selectedFunds = getSelectedFunds();
    selectedFunds.forEach(fundId => {
        const checkbox = document.getElementById(`fund-${fundId}`);
        if (checkbox && !checkbox.disabled) {
            checkbox.checked = true;
            const card = document.querySelector(`[data-fund-id="${fundId}"]`);
            if (card) {
                const indicator = card.querySelector('.selection-indicator');
                const checkmark = card.querySelector('.checkmark');

                card.style.borderColor = 'rgb(96, 165, 250)';
                card.style.borderWidth = '2px';
                indicator.style.backgroundColor = 'rgb(96, 165, 250)';
                indicator.style.borderColor = 'rgb(96, 165, 250)';
                checkmark.classList.remove('hidden');
            }
        }
    });
    updateSelectedCount();
}

function applyFilters() {
    document.getElementById('filterForm').submit();
}

function clearSelections() {
    localStorage.removeItem(STORAGE_KEY);
}

// Before form submission, ensure all selected funds are included
document.getElementById('fundSelectionForm').addEventListener('submit', function(e) {
    const selectedFunds = getSelectedFunds();

    // Remove existing checkboxes
    document.querySelectorAll('.fund-checkbox').forEach(cb => cb.remove());

    // Add all selected funds as hidden inputs
    selectedFunds.forEach(fundId => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_funds';
        input.value = fundId;
        this.appendChild(input);
    });

    // Clear localStorage after successful submission
    localStorage.removeItem(STORAGE_KEY);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    restoreSelections();
});
</script>
{% endblock %}
